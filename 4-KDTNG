local SoloLagDetector = {}
SoloLagDetector.IsMonitoring = false
SoloLagDetector.Metrics = {
    serverResponseTimes = {},
    physicsLatency = {},
    networkStability = {}
}

function SoloLagDetector.createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "SoloLagDetectorGUI"
    screenGui.ResetOnSpawn = false
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 400, 0, 500)
    mainFrame.Position = UDim2.new(0, 10, 0, 10)
    mainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.2)
    mainFrame.BorderSizePixel = 0
    mainFrame.Active = true
    mainFrame.Draggable = true
    
    -- æ ‡é¢˜æ 
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = Color3.new(0.2, 0.2, 0.4)
    titleBar.Parent = mainFrame
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, 0, 1, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "ğŸ¯ å•ç©å®¶æœåŠ¡å™¨å¡é¡¿æ£€æµ‹å™¨"
    titleLabel.TextColor3 = Color3.new(1, 1, 1)
    titleLabel.TextSize = 14
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Parent = titleBar
    
    -- æ§åˆ¶åŒºåŸŸ
    local controlFrame = Instance.new("Frame")
    controlFrame.Size = UDim2.new(1, -10, 0, 80)
    controlFrame.Position = UDim2.new(0, 5, 0, 35)
    controlFrame.BackgroundTransparency = 1
    controlFrame.Parent = mainFrame
    
    local startButton = Instance.new("TextButton")
    startButton.Size = UDim2.new(0.5, -5, 0, 35)
    startButton.Position = UDim2.new(0, 0, 0, 0)
    startButton.BackgroundColor3 = Color3.new(0.2, 0.6, 0.2)
    startButton.Text = "â–¶ï¸ å¼€å§‹åŸºå‡†æµ‹è¯•"
    startButton.TextColor3 = Color3.new(1, 1, 1)
    startButton.Parent = controlFrame
    
    local stopButton = Instance.new("TextButton")
    stopButton.Size = UDim2.new(0.5, -5, 0, 35)
    stopButton.Position = UDim2.new(0.5, 5, 0, 0)
    stopButton.BackgroundColor3 = Color3.new(0.6, 0.2, 0.2)
    stopButton.Text = "â¹ï¸ åœæ­¢æµ‹è¯•"
    stopButton.TextColor3 = Color3.new(1, 1, 1)
    stopButton.Parent = controlFrame
    
    local attackButton = Instance.new("TextButton")
    attackButton.Size = UDim2.new(1, 0, 0, 35)
    attackButton.Position = UDim2.new(0, 0, 0, 40)
    attackButton.BackgroundColor3 = Color3.new(0.8, 0.4, 0.1)
    attackButton.Text = "ğŸ’¥ å¼€å§‹æ”»å‡»å¹¶å¯¹æ¯”"
    attackButton.TextColor3 = Color3.new(1, 1, 1)
    attackButton.Parent = controlFrame
    
    -- æ•°æ®æ˜¾ç¤ºåŒºåŸŸ
    local displayFrame = Instance.new("Frame")
    displayFrame.Size = UDim2.new(1, -10, 1, -125)
    displayFrame.Position = UDim2.new(0, 5, 0, 120)
    displayFrame.BackgroundColor3 = Color3.new(0.05, 0.05, 0.1)
    displayFrame.Parent = mainFrame
    
    local contentLabel = Instance.new("TextLabel")
    contentLabel.Size = UDim2.new(1, -10, 1, -10)
    contentLabel.Position = UDim2.new(0, 5, 0, 5)
    contentLabel.BackgroundTransparency = 1
    contentLabel.Text = "ç‚¹å‡»å¼€å§‹åŸºå‡†æµ‹è¯•..."
    contentLabel.TextColor3 = Color3.new(1, 1, 1)
    contentLabel.TextSize = 12
    contentLabel.TextWrapped = true
    contentLabel.TextXAlignment = Enum.TextXAlignment.Left
    contentLabel.TextYAlignment = Enum.TextYAlignment.Top
    contentLabel.Parent = displayFrame
    
    screenGui.Parent = game:GetService("CoreGui")
    mainFrame.Parent = screenGui
    
    SoloLagDetector.UI = {
        ScreenGui = screenGui,
        MainFrame = mainFrame,
        StartButton = startButton,
        StopButton = stopButton,
        AttackButton = attackButton,
        ContentLabel = contentLabel
    }
    
    return mainFrame
end

-- æ›´æ–°æ˜¾ç¤ºå†…å®¹
function SoloLagDetector.updateDisplay(text)
    if SoloLagDetector.UI and SoloLagDetector.UI.ContentLabel then
        SoloLagDetector.UI.ContentLabel.Text = text
    end
end

-- æµ‹é‡æœåŠ¡å™¨å“åº”æ—¶é—´
function SoloLagDetector.measureServerResponse()
    local startTime = tick()
    
    -- ä½¿ç”¨ä¸€ä¸ªç®€å•çš„è¿œç¨‹è°ƒç”¨æ¥æµ‹è¯•å“åº”æ—¶é—´
    local testRemote = SoloLagDetector.findTestRemote()
    if testRemote then
        local success, result = pcall(function()
            if testRemote:IsA("RemoteFunction") then
                return testRemote:InvokeServer("ping_test")
            else
                testRemote:FireServer("ping_test")
                return true
            end
        end)
        
        local responseTime = (tick() - startTime) * 1000 -- è½¬æ¢ä¸ºæ¯«ç§’
        return responseTime, success
    end
    
    return nil, false
end

-- å¯»æ‰¾ç”¨äºæµ‹è¯•çš„Remote
function SoloLagDetector.findTestRemote()
    local services = {
        game:GetService("ReplicatedStorage"),
        game:GetService("ServerScriptService"),
        game:GetService("Players")
    }
    
    for _, service in ipairs(services) do
        for _, item in ipairs(service:GetDescendants()) do
            if item:IsA("RemoteEvent") or item:IsA("RemoteFunction") then
                -- ä¼˜å…ˆé€‰æ‹©åç§°ç®€å•çš„Remote
                local name = item.Name:lower()
                if name:find("ping") or name:find("test") or name:find("update") then
                    return item
                end
            end
        end
    end
    
    -- å¦‚æœæ²¡æ‰¾åˆ°åˆé€‚çš„ï¼Œè¿”å›ç¬¬ä¸€ä¸ªRemote
    for _, service in ipairs(services) do
        for _, item in ipairs(service:GetDescendants()) do
            if item:IsA("RemoteEvent") or item:IsA("RemoteFunction") then
                return item
            end
        end
    end
    
    return nil
end

-- æµ‹é‡ç‰©ç†å»¶è¿Ÿ
function SoloLagDetector.measurePhysicsLatency()
    local startTime = tick()
    
    -- é€šè¿‡ç§»åŠ¨è§’è‰²æ¥æµ‹è¯•ç‰©ç†å“åº”
    local character = game.Players.LocalPlayer.Character
    if character and character:FindFirstChild("Humanoid") then
        local humanoid = character.Humanoid
        local originalPosition = character.PrimaryPart.Position
        
        -- è½»å¾®ç§»åŠ¨å¹¶æµ‹é‡è¿”å›æ—¶é—´
        humanoid:MoveTo(originalPosition + Vector3.new(1, 0, 0))
        wait(0.1)
        humanoid:MoveTo(originalPosition)
        
        return (tick() - startTime) * 1000
    end
    
    return 0
end

-- æµ‹é‡ç½‘ç»œç¨³å®šæ€§
function SoloLagDetector.measureNetworkStability()
    local stabilityScore = 100
    local testResults = {}
    
    -- å¤šæ¬¡æµ‹é‡å“åº”æ—¶é—´
    for i = 1, 5 do
        local responseTime = SoloLagDetector.measureServerResponse()
        if responseTime then
            table.insert(testResults, responseTime)
            wait(0.1)
        end
    end
    
    -- è®¡ç®—ç¨³å®šæ€§ï¼ˆæ–¹å·®è¶Šå°è¶Šç¨³å®šï¼‰
    if #testResults > 1 then
        local average = 0
        for _, time in ipairs(testResults) do
            average = average + time
        end
        average = average / #testResults
        
        local variance = 0
        for _, time in ipairs(testResults) do
            variance = variance + (time - average) ^ 2
        end
        variance = variance / #testResults
        
        stabilityScore = math.max(0, 100 - variance * 10)
    end
    
    return stabilityScore, testResults
end

-- å¼€å§‹åŸºå‡†æµ‹è¯•
function SoloLagDetector.startBaselineTest()
    if SoloLagDetector.IsMonitoring then return end
    
    SoloLagDetector.IsMonitoring = true
    SoloLagDetector.BaselineMetrics = {}
    SoloLagDetector.Metrics = {
        serverResponseTimes = {},
        physicsLatency = {},
        networkStability = {}
    }
    
    SoloLagDetector.UI.StartButton.BackgroundColor3 = Color3.new(0.6, 0.6, 0.2)
    SoloLagDetector.UI.StartButton.Text = "æµ‹è¯•ä¸­..."
    
    SoloLagDetector.updateDisplay("å¼€å§‹åŸºå‡†æµ‹è¯•...\n\næ­£åœ¨æµ‹é‡æœåŠ¡å™¨æ€§èƒ½åŸºå‡†...")
    
    -- æµ‹è¯•å¾ªç¯
    SoloLagDetector.TestConnection = game:GetService("RunService").Heartbeat:Connect(function()
        if not SoloLagDetector.IsMonitoring then return end
        
        -- æµ‹é‡å„é¡¹æŒ‡æ ‡
        local responseTime = SoloLagDetector.measureServerResponse()
        local physicsTime = SoloLagDetector.measurePhysicsLatency()
        local stability, stabilityResults = SoloLagDetector.measureNetworkStability()
        
        -- è®°å½•æ•°æ®
        if responseTime then
            table.insert(SoloLagDetector.Metrics.serverResponseTimes, responseTime)
            if #SoloLagDetector.Metrics.serverResponseTimes > 50 then
                table.remove(SoloLagDetector.Metrics.serverResponseTimes, 1)
            end
        end
        
        table.insert(SoloLagDetector.Metrics.physicsLatency, physicsTime)
        if #SoloLagDetector.Metrics.physicsLatency > 50 then
            table.remove(SoloLagDetector.Metrics.physicsLatency, 1)
        end
        
        table.insert(SoloLagDetector.Metrics.networkStability, stability)
        if #SoloLagDetector.Metrics.networkStability > 50 then
            table.remove(SoloLagDetector.Metrics.networkStability, 1)
        end
        
        -- è®¡ç®—å¹³å‡å€¼
        local avgResponse = SoloLagDetector.calculateAverage(SoloLagDetector.Metrics.serverResponseTimes)
        local avgPhysics = SoloLagDetector.calculateAverage(SoloLagDetector.Metrics.physicsLatency)
        local avgStability = SoloLagDetector.calculateAverage(SoloLagDetector.Metrics.networkStability)
        
        -- æ›´æ–°æ˜¾ç¤º
        local displayText = string.format(
            "ğŸ åŸºå‡†æµ‹è¯•è¿›è¡Œä¸­...\n\n" ..
            "ğŸ“Š å®æ—¶æŒ‡æ ‡:\n" ..
            "â€¢ æœåŠ¡å™¨å“åº”: %.1f ms\n" ..
            "â€¢ ç‰©ç†å»¶è¿Ÿ: %.1f ms\n" ..
            "â€¢ ç½‘ç»œç¨³å®šæ€§: %.0f/100\n\n" ..
            "ğŸ“ˆ æµ‹è¯•è¯´æ˜:\n" ..
            "å“åº”æ—¶é—´ < 50ms: ä¼˜ç§€\n" ..
            "å“åº”æ—¶é—´ 50-100ms: è‰¯å¥½\n" ..
            "å“åº”æ—¶é—´ 100-200ms: ä¸€èˆ¬\n" ..
            "å“åº”æ—¶é—´ > 200ms: å¡é¡¿\n\n" ..
            "è¿è¡Œ %d æ¬¡æµ‹è¯•",
            avgResponse or 0, avgPhysics or 0, avgStability or 0,
            #SoloLagDetector.Metrics.serverResponseTimes
        )
        
        SoloLagDetector.updateDisplay(displayText)
        
        -- ä¿å­˜åŸºå‡†æ•°æ®ï¼ˆå‰10æ¬¡æµ‹é‡åï¼‰
        if #SoloLagDetector.Metrics.serverResponseTimes == 10 and not SoloLagDetector.BaselineMetrics.established then
            SoloLagDetector.BaselineMetrics = {
                serverResponse = avgResponse,
                physicsLatency = avgPhysics,
                networkStability = avgStability,
                established = true
            }
            SoloLagDetector.updateDisplay(displayText .. "\n\nâœ… åŸºå‡†æ•°æ®å·²ä¿å­˜!")
        end
    end)
end

-- è®¡ç®—å¹³å‡å€¼
function SoloLagDetector.calculateAverage(values)
    if #values == 0 then return 0 end
    
    local sum = 0
    for _, value in ipairs(values) do
        sum = sum + value
    end
    return sum / #values
end

-- å¼€å§‹æ”»å‡»å¯¹æ¯”æµ‹è¯•
function SoloLagDetector.startAttackComparison()
    if not SoloLagDetector.BaselineMetrics or not SoloLagDetector.BaselineMetrics.established then
        SoloLagDetector.updateDisplay("âŒ è¯·å…ˆå®ŒæˆåŸºå‡†æµ‹è¯•!")
        return
    end
    
    SoloLagDetector.AttackMode = true
    SoloLagDetector.updateDisplay("ğŸ’¥ å¼€å§‹æ”»å‡»å¯¹æ¯”æµ‹è¯•...\n\nåŸºå‡†æ•°æ®:\n" ..
        string.format("å“åº”: %.1fms, ç‰©ç†: %.1fms, ç¨³å®š: %.0f/100\n\næ”»å‡»è¿›è¡Œä¸­...",
        SoloLagDetector.BaselineMetrics.serverResponse,
        SoloLagDetector.BaselineMetrics.physicsLatency,
        SoloLagDetector.BaselineMetrics.networkStability))
    
    -- è¿™é‡Œå¯ä»¥é›†æˆä½ çš„æ”»å‡»è„šæœ¬
    SoloLagDetector.simulateServerAttack()
end

-- æ¨¡æ‹ŸæœåŠ¡å™¨æ”»å‡»ï¼ˆé›†æˆä½ çš„æ”»å‡»è„šæœ¬ï¼‰
function SoloLagDetector.simulateServerAttack()
    -- æ”¶é›†æ‰€æœ‰Remoteå¯¹è±¡
    local attackRemotes = {}
    local services = {
        game:GetService("ReplicatedStorage"),
        game:GetService("ServerScriptService"),
        game:GetService("Players")
    }
    
    for _, service in ipairs(services) do
        for _, item in ipairs(service:GetDescendants()) do
            if item:IsA("RemoteEvent") or item:IsA("RemoteFunction") then
                table.insert(attackRemotes, item)
            end
        end
    end
    
    -- å¼€å§‹æ”»å‡»
    spawn(function()
        while SoloLagDetector.AttackMode do
            for _, remote in ipairs(attackRemotes) do
                if remote and remote.Parent then
                    pcall(function()
                        local attackData = {
                            type = "stress_test",
                            timestamp = tick(),
                            data = string.rep("X", math.random(10, 100))
                        }
                        
                        if remote:IsA("RemoteEvent") then
                            remote:FireServer(attackData)
                        else
                            remote:InvokeServer(attackData)
                        end
                    end)
                end
            end
            wait(0.05) -- æ”»å‡»é¢‘ç‡
        end
    end)
    
    -- ç›‘æ§æ”»å‡»æ•ˆæœ
    spawn(function()
        local attackStartTime = tick()
        local maxResponseTime = 0
        local attackMetrics = {
            serverResponseTimes = {},
            physicsLatency = {},
            networkStability = {}
        }
        
        while SoloLagDetector.AttackMode do
            -- æµ‹é‡æ”»å‡»æœŸé—´çš„æ€§èƒ½
            local responseTime = SoloLagDetector.measureServerResponse()
            local physicsTime = SoloLagDetector.measurePhysicsLatency()
            local stability = SoloLagDetector.measureNetworkStability()
            
            if responseTime then
                table.insert(attackMetrics.serverResponseTimes, responseTime)
                maxResponseTime = math.max(maxResponseTime, responseTime)
            end
            
            local currentAvgResponse = SoloLagDetector.calculateAverage(attackMetrics.serverResponseTimes)
            local performanceDrop = 0
            
            if SoloLagDetector.BaselineMetrics.serverResponse > 0 then
                performanceDrop = ((currentAvgResponse / SoloLagDetector.BaselineMetrics.serverResponse) - 1) * 100
            end
            
            local attackDuration = tick() - attackStartTime
            
            local displayText = string.format(
                "ğŸ’¥ æ”»å‡»æµ‹è¯•è¿›è¡Œä¸­...\n\n" ..
                "â±ï¸ æ”»å‡»æ—¶é•¿: %.1fç§’\n" ..
                "ğŸ“Š å½“å‰æ€§èƒ½:\n" ..
                "â€¢ å“åº”: %.1fms (åŸºå‡†: %.1fms)\n" ..
                "â€¢ æ€§èƒ½ä¸‹é™: +%.0f%%\n" ..
                "â€¢ æœ€å¤§å»¶è¿Ÿ: %.1fms\n\n" ..
                "ğŸ¯ æ”»å‡»æ•ˆæœè¯„ä¼°:\n",
                attackDuration,
                currentAvgResponse,
                SoloLagDetector.BaselineMetrics.serverResponse,
                performanceDrop,
                maxResponseTime
            )
            
            -- æ•ˆæœè¯„ä¼°
            if performanceDrop > 100 then
                displayText = displayText .. "âœ… æ”»å‡»æ•ˆæœæ˜¾è‘— - æœåŠ¡å™¨æ˜æ˜¾å¡é¡¿"
            elseif performanceDrop > 50 then
                displayText = displayText .. "âš ï¸ æ”»å‡»æ•ˆæœä¸€èˆ¬ - æœåŠ¡å™¨è½»å¾®å¡é¡¿"
            else
                displayText = displayText .. "âŒ æ”»å‡»æ•ˆæœä¸æ˜æ˜¾ - æœåŠ¡å™¨æ€§èƒ½æ­£å¸¸"
            end
            
            SoloLagDetector.updateDisplay(displayText)
            wait(1)
        end
    end)
end

-- åœæ­¢æµ‹è¯•
function SoloLagDetector.stopTest()
    SoloLagDetector.IsMonitoring = false
    SoloLagDetector.AttackMode = false
    
    if SoloLagDetector.TestConnection then
        SoloLagDetector.TestConnection:Disconnect()
    end
    
    SoloLagDetector.UI.StartButton.BackgroundColor3 = Color3.new(0.2, 0.6, 0.2)
    SoloLagDetector.UI.StartButton.Text = "â–¶ï¸ å¼€å§‹åŸºå‡†æµ‹è¯•"
    
    if SoloLagDetector.BaselineMetrics and SoloLagDetector.BaselineMetrics.established then
        SoloLagDetector.updateDisplay("âœ… æµ‹è¯•å®Œæˆ!\n\nåŸºå‡†æ•°æ®å·²ä¿å­˜\nå¯ä»¥å¼€å§‹æ”»å‡»å¯¹æ¯”æµ‹è¯•")
    else
        SoloLagDetector.updateDisplay("æµ‹è¯•å·²åœæ­¢")
    end
end

-- åˆå§‹åŒ–
function SoloLagDetector.init()
    if not game:IsLoaded() then
        game.Loaded:Wait()
    end
    
    SoloLagDetector.createUI()
    
    -- è®¾ç½®æŒ‰é’®äº‹ä»¶
    SoloLagDetector.UI.StartButton.MouseButton1Click:Connect(function()
        SoloLagDetector.startBaselineTest()
    end)
    
    SoloLagDetector.UI.StopButton.MouseButton1Click:Connect(function()
        SoloLagDetector.stopTest()
    end)
    
    SoloLagDetector.UI.AttackButton.MouseButton1Click:Connect(function()
        SoloLagDetector.startAttackComparison()
    end)
    
    -- æ·»åŠ å¿«æ·é”®
    game:GetService("UserInputService").InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == Enum.KeyCode.F6 then
            if not SoloLagDetector.IsMonitoring then
                SoloLagDetector.startBaselineTest()
            else
                SoloLagDetector.stopTest()
            end
        end
    end)
end

-- è‡ªåŠ¨å¯åŠ¨
spawn(function()
    wait(2)
    SoloLagDetector.init()
end)

return SoloLagDetector