-- 物理延迟监测
local PhysicsSecurityMonitor = {}
PhysicsSecurityMonitor.IsMonitoring = false
PhysicsSecurityMonitor.Metrics = {
    physicsLatency = {},
    frameTimes = {},
    performanceStats = {}
}

-- 安全监测阈值
PhysicsSecurityMonitor.SecurityThresholds = {
    highLatency = 100,    -- 超过100ms视为异常
    highVariance = 50,    -- 波动超过50ms视为异常
    fpsDrop = 20,         -- FPS下降超过20帧视为异常
}

PhysicsSecurityMonitor.AnomalyCount = 0
PhysicsSecurityMonitor.NormalBaseline = nil
PhysicsSecurityMonitor.SecurityAlerts = {}

-- 创建UI界面
function PhysicsSecurityMonitor.createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PhysicsSecurityMonitorGUI"
    screenGui.ResetOnSpawn = false

    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 400, 0, 400)
    mainFrame.Position = UDim2.new(0, 10, 0, 10)
    mainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.2)
    mainFrame.BorderSizePixel = 0
    mainFrame.Active = true
    mainFrame.Draggable = true

    -- 标题栏
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = Color3.new(0.2, 0.2, 0.4)
    titleBar.Parent = mainFrame

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, 0, 1, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "物理延迟与安全监测器"
    titleLabel.TextColor3 = Color3.new(1, 1, 1)
    titleLabel.TextSize = 14
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Parent = titleBar

    -- 控制区域
    local controlFrame = Instance.new("Frame")
    controlFrame.Size = UDim2.new(1, -10, 0, 80)
    controlFrame.Position = UDim2.new(0, 5, 0, 35)
    controlFrame.BackgroundTransparency = 1
    controlFrame.Parent = mainFrame

    local startButton = Instance.new("TextButton")
    startButton.Size = UDim2.new(0.5, -5, 0, 35)
    startButton.Position = UDim2.new(0, 0, 0, 0)
    startButton.BackgroundColor3 = Color3.new(0.2, 0.6, 0.2)
    startButton.Text = "开始监测"
    startButton.TextColor3 = Color3.new(1, 1, 1)
    startButton.Parent = controlFrame

    local stopButton = Instance.new("TextButton")
    stopButton.Size = UDim2.new(0.5, -5, 0, 35)
    stopButton.Position = UDim2.new(0.5, 5, 0, 0)
    stopButton.BackgroundColor3 = Color3.new(0.6, 0.2, 0.2)
    stopButton.Text = "停止监测"
    stopButton.TextColor3 = Color3.new(1, 1, 1)
    stopButton.Parent = controlFrame

    local securityButton = Instance.new("TextButton")
    securityButton.Size = UDim2.new(1, 0, 0, 35)
    securityButton.Position = UDim2.new(0, 0, 0, 40)
    securityButton.BackgroundColor3 = Color3.new(0.3, 0.3, 0.6)
    securityButton.Text = "安全监测: 关闭"
    securityButton.TextColor3 = Color3.new(1, 1, 1)
    securityButton.Parent = controlFrame

    -- 数据显示区域
    local displayFrame = Instance.new("Frame")
    displayFrame.Size = UDim2.new(1, -10, 1, -125)
    displayFrame.Position = UDim2.new(0, 5, 0, 120)
    displayFrame.BackgroundColor3 = Color3.new(0.05, 0.05, 0.1)
    displayFrame.Parent = mainFrame

    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Size = UDim2.new(1, -10, 1, -10)
    scrollFrame.Position = UDim2.new(0, 5, 0, 5)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.ScrollBarThickness = 8
    scrollFrame.Parent = displayFrame

    local contentLabel = Instance.new("TextLabel")
    contentLabel.Size = UDim2.new(1, 0, 0, 0)
    contentLabel.BackgroundTransparency = 1
    contentLabel.Text = "点击开始监测物理延迟..."
    contentLabel.TextColor3 = Color3.new(1, 1, 1)
    contentLabel.TextSize = 11
    contentLabel.TextWrapped = true
    contentLabel.TextXAlignment = Enum.TextXAlignment.Left
    contentLabel.TextYAlignment = Enum.TextYAlignment.Top
    contentLabel.AutomaticSize = Enum.AutomaticSize.Y
    contentLabel.Parent = scrollFrame

    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, contentLabel.TextBounds.Y)

    screenGui.Parent = game:GetService("CoreGui")
    mainFrame.Parent = screenGui

    PhysicsSecurityMonitor.UI = {
        ScreenGui = screenGui,
        MainFrame = mainFrame,
        StartButton = startButton,
        StopButton = stopButton,
        SecurityButton = securityButton,
        ContentLabel = contentLabel,
        ScrollFrame = scrollFrame
    }

    return mainFrame
end

-- 更新显示内容
function PhysicsSecurityMonitor.updateDisplay(text)
    if PhysicsSecurityMonitor.UI and PhysicsSecurityMonitor.UI.ContentLabel then
        PhysicsSecurityMonitor.UI.ContentLabel.Text = text
        PhysicsSecurityMonitor.UI.ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, PhysicsSecurityMonitor.UI.ContentLabel.TextBounds.Y)
        PhysicsSecurityMonitor.UI.ScrollFrame.CanvasPosition = Vector2.new(0, PhysicsSecurityMonitor.UI.ContentLabel.TextBounds.Y)
    end
end

-- 精确测量物理延迟
function PhysicsSecurityMonitor.measurePhysicsLatency()
    local runService = game:GetService("RunService")
    local startTime = tick()
    
    runService.Heartbeat:Wait()
    local frameTime = (tick() - startTime) * 1000
    
    return frameTime
end

-- 测量FPS
function PhysicsSecurityMonitor.measureFPS()
    local frameTime = PhysicsSecurityMonitor.measurePhysicsLatency()
    if frameTime > 0 then
        return math.floor(1000 / frameTime)
    end
    return 0
end

-- 获取性能统计
function PhysicsSecurityMonitor.getPerformanceStats()
    local stats = game:GetService("Stats")
    local performanceStats = {}
    
    local memoryStats = stats:FindFirstChild("Memory")
    if memoryStats then
        performanceStats.memory = memoryStats:FindFirstChild("UsedMemory") and memoryStats.UsedMemory.Value or 0
    end
    
    local networkStats = stats:FindFirstChild("Network")
    if networkStats then
        performanceStats.ping = networkStats:FindFirstChild("Ping") and networkStats.Ping.Value or 0
        performanceStats.dataSent = networkStats:FindFirstChild("DataSent") and networkStats.DataSent.Value or 0
        performanceStats.dataReceived = networkStats:FindFirstChild("DataReceived") and networkStats.DataReceived.Value or 0
    end
    
    return performanceStats
end

-- 计算统计函数
function PhysicsSecurityMonitor.calculateMin(values)
    if #values == 0 then return 0 end
    local min = values[1]
    for i = 2, #values do
        if values[i] < min then
            min = values[i]
        end
    end
    return min
end

function PhysicsSecurityMonitor.calculateMax(values)
    if #values == 0 then return 0 end
    local max = values[1]
    for i = 2, #values do
        if values[i] > max then
            max = values[i]
        end
    end
    return max
end

function PhysicsSecurityMonitor.calculateAverage(values)
    if #values == 0 then return 0 end
    local sum = 0
    for _, value in ipairs(values) do
        sum = sum + value
    end
    return sum / #values
end

-- 安全监测功能
function PhysicsSecurityMonitor.detectAnomalies()
    if not PhysicsSecurityMonitor.IsMonitoring then return end
    
    local currentMetrics = {
        latency = PhysicsSecurityMonitor.calculateAverage(PhysicsSecurityMonitor.Metrics.physicsLatency),
        fps = PhysicsSecurityMonitor.calculateAverage(PhysicsSecurityMonitor.Metrics.frameTimes),
        variance = PhysicsSecurityMonitor.calculateMax(PhysicsSecurityMonitor.Metrics.physicsLatency) - 
                  PhysicsSecurityMonitor.calculateMin(PhysicsSecurityMonitor.Metrics.physicsLatency)
    }
    
    -- 建立正常基线
    if not PhysicsSecurityMonitor.NormalBaseline and #PhysicsSecurityMonitor.Metrics.physicsLatency > 30 then
        PhysicsSecurityMonitor.NormalBaseline = currentMetrics
        PhysicsSecurityMonitor.updateDisplay("安全基线已建立\n开始异常监测...")
    end
    
    -- 检测异常
    if PhysicsSecurityMonitor.NormalBaseline then
        local anomalies = {}
        
        -- 检测高延迟
        if currentMetrics.latency > PhysicsSecurityMonitor.SecurityThresholds.highLatency then
            table.insert(anomalies, "高物理延迟")
        end
        
        -- 检测异常波动
        if currentMetrics.variance > PhysicsSecurityMonitor.SecurityThresholds.highVariance then
            table.insert(anomalies, "异常波动")
        end
        
        -- 检测FPS骤降
        if PhysicsSecurityMonitor.NormalBaseline.fps - currentMetrics.fps > PhysicsSecurityMonitor.SecurityThresholds.fpsDrop then
            table.insert(anomalies, "FPS骤降")
        end
        
        -- 处理检测结果
        if #anomalies > 0 then
            PhysicsSecurityMonitor.AnomalyCount = PhysicsSecurityMonitor.AnomalyCount + 1
            
            if PhysicsSecurityMonitor.AnomalyCount >= 3 then
                PhysicsSecurityMonitor.triggerSecurityAlert(table.concat(anomalies, ", "), currentMetrics)
            end
        else
            PhysicsSecurityMonitor.AnomalyCount = math.max(0, PhysicsSecurityMonitor.AnomalyCount - 1)
        end
    end
end

-- 安全警报
function PhysicsSecurityMonitor.triggerSecurityAlert(reason, metrics)
    local alertTime = os.date("%H:%M:%S")
    local alertId = tick()
    
    -- 记录警报
    table.insert(PhysicsSecurityMonitor.SecurityAlerts, {
        time = alertTime,
        reason = reason,
        metrics = metrics,
        id = alertId
    })
    
    -- 在界面上显示警告
    local alertText = string.format(
        "安全警报\n\n" ..
        "检测到可能的服务器异常:\n%s\n\n" ..
        "当前指标:\n" ..
        "延迟: %.1fms | FPS: %d\n" ..
        "波动: %.1fms\n\n" ..
        "时间: %s\n" ..
        "警报ID: %.0f\n\n" ..
        "建议: 如持续出现请报告管理员",
        reason, metrics.latency, metrics.fps, metrics.variance, alertTime, alertId
    )
    
    -- 改变界面颜色以示警告
    PhysicsSecurityMonitor.UI.MainFrame.BackgroundColor3 = Color3.new(0.3, 0.1, 0.1)
    
    -- 恢复颜色（8秒后）
    delay(8, function()
        if PhysicsSecurityMonitor.UI and PhysicsSecurityMonitor.UI.MainFrame then
            PhysicsSecurityMonitor.UI.MainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.2)
        end
    end)
    
    PhysicsSecurityMonitor.updateDisplay(alertText)
    
    -- 输出到控制台
    warn(string.format("[安全监测] 警报 #%d: %s at %s", #PhysicsSecurityMonitor.SecurityAlerts, reason, alertTime))
end

-- 切换安全监测
function PhysicsSecurityMonitor.toggleSecurityMonitoring()
    PhysicsSecurityMonitor.SecurityMonitoring = not PhysicsSecurityMonitor.SecurityMonitoring
    
    if PhysicsSecurityMonitor.SecurityMonitoring then
        PhysicsSecurityMonitor.UI.SecurityButton.BackgroundColor3 = Color3.new(0.2, 0.6, 0.2)
        PhysicsSecurityMonitor.UI.SecurityButton.Text = "安全监测: 开启"
        PhysicsSecurityMonitor.updateDisplay("安全监测已启用\n将检测服务器异常行为...")
    else
        PhysicsSecurityMonitor.UI.SecurityButton.BackgroundColor3 = Color3.new(0.3, 0.3, 0.6)
        PhysicsSecurityMonitor.UI.SecurityButton.Text = "安全监测: 关闭"
        PhysicsSecurityMonitor.updateDisplay("安全监测已关闭")
    end
end

-- 显示安全日志
function PhysicsSecurityMonitor.showSecurityLog()
    if #PhysicsSecurityMonitor.SecurityAlerts == 0 then
        return "暂无安全警报"
    end
    
    local logText = "安全警报日志:\n\n"
    for i, alert in ipairs(PhysicsSecurityMonitor.SecurityAlerts) do
        logText = logText .. string.format("%d. [%s] %s\n", i, alert.time, alert.reason)
    end
    
    return logText
end

-- 开始监测
function PhysicsSecurityMonitor.startMonitoring()
    if PhysicsSecurityMonitor.IsMonitoring then return end

    PhysicsSecurityMonitor.IsMonitoring = true
    PhysicsSecurityMonitor.Metrics = {
        physicsLatency = {},
        frameTimes = {},
        performanceStats = {}
    }

    PhysicsSecurityMonitor.UI.StartButton.BackgroundColor3 = Color3.new(0.6, 0.6, 0.2)
    PhysicsSecurityMonitor.UI.StartButton.Text = "监测中..."

    PhysicsSecurityMonitor.updateDisplay("开始监测物理延迟...\n\n正在收集基准数据...")

    -- 主监测循环
    PhysicsSecurityMonitor.MonitorConnection = game:GetService("RunService").Heartbeat:Connect(function()
        if not PhysicsSecurityMonitor.IsMonitoring then return end

        -- 测量物理延迟
        local physicsTime = PhysicsSecurityMonitor.measurePhysicsLatency()
        local fps = PhysicsSecurityMonitor.measureFPS()
        local performanceStats = PhysicsSecurityMonitor.getPerformanceStats()

        -- 记录数据
        table.insert(PhysicsSecurityMonitor.Metrics.physicsLatency, physicsTime)
        table.insert(PhysicsSecurityMonitor.Metrics.frameTimes, fps)
        table.insert(PhysicsSecurityMonitor.Metrics.performanceStats, performanceStats)
        
        -- 保持数据量合理
        if #PhysicsSecurityMonitor.Metrics.physicsLatency > 200 then
            table.remove(PhysicsSecurityMonitor.Metrics.physicsLatency, 1)
        end
        if #PhysicsSecurityMonitor.Metrics.frameTimes > 200 then
            table.remove(PhysicsSecurityMonitor.Metrics.frameTimes, 1)
        end
        if #PhysicsSecurityMonitor.Metrics.performanceStats > 200 then
            table.remove(PhysicsSecurityMonitor.Metrics.performanceStats, 1)
        end

        -- 计算统计信息
        local avgPhysics = PhysicsSecurityMonitor.calculateAverage(PhysicsSecurityMonitor.Metrics.physicsLatency)
        local minPhysics = PhysicsSecurityMonitor.calculateMin(PhysicsSecurityMonitor.Metrics.physicsLatency)
        local maxPhysics = PhysicsSecurityMonitor.calculateMax(PhysicsSecurityMonitor.Metrics.physicsLatency)
        local avgFPS = PhysicsSecurityMonitor.calculateAverage(PhysicsSecurityMonitor.Metrics.frameTimes)
        
        local currentStats = performanceStats
        local variance = maxPhysics - minPhysics

        -- 更新显示
        local displayText = string.format(
            "物理延迟监测 - 实时数据\n\n" ..
            "帧时间: %.1f ms\n" ..
            "FPS: %d\n" ..
            "波动范围: %.1f - %.1f ms\n" ..
            "波动幅度: %.1f ms\n\n" ..
            "性能统计:\n" ..
            "内存使用: %.1f MB\n" ..
            "网络延迟: %.0f ms\n" ..
            "数据收发: ↑%.1fKB ↓%.1fKB\n\n" ..
            "安全监测: %s\n" ..
            "异常计数: %d/3\n\n",
            avgPhysics, avgFPS, minPhysics, maxPhysics, variance,
            (currentStats.memory or 0) / 1024 / 1024,
            currentStats.ping or 0,
            (currentStats.dataSent or 0) / 1024,
            (currentStats.dataReceived or 0) / 1024,
            PhysicsSecurityMonitor.SecurityMonitoring and "开启" or "关闭",
            PhysicsSecurityMonitor.AnomalyCount
        )
        
        -- 性能评级
        if avgPhysics < 16.7 then
            displayText = displayText .. "性能: 优秀 (60+ FPS)\n"
        elseif avgPhysics < 33.3 then
            displayText = displayText .. "性能: 良好 (30-60 FPS)\n"
        elseif avgPhysics < 50 then
            displayText = displayText .. "性能: 一般 (20-30 FPS)\n"
        else
            displayText = displayText .. "性能: 卡顿 (<20 FPS)\n"
        end
        
        -- 安全状态
        if PhysicsSecurityMonitor.SecurityMonitoring then
            if PhysicsSecurityMonitor.AnomalyCount >= 2 then
                displayText = displayText .. "安全状态: 可疑\n"
            else
                displayText = displayText .. "安全状态: 正常\n"
            end
        end
        
        displayText = displayText .. string.format("\n已监测 %d 帧", #PhysicsSecurityMonitor.Metrics.physicsLatency)

        -- 每60帧执行一次安全检测
        if PhysicsSecurityMonitor.SecurityMonitoring and #PhysicsSecurityMonitor.Metrics.physicsLatency % 60 == 0 then
            PhysicsSecurityMonitor.detectAnomalies()
        end

        PhysicsSecurityMonitor.updateDisplay(displayText)
    end)
end

-- 停止监测
function PhysicsSecurityMonitor.stopMonitoring()
    PhysicsSecurityMonitor.IsMonitoring = false

    if PhysicsSecurityMonitor.MonitorConnection then
        PhysicsSecurityMonitor.MonitorConnection:Disconnect()
    end

    PhysicsSecurityMonitor.UI.StartButton.BackgroundColor3 = Color3.new(0.2, 0.6, 0.2)
    PhysicsSecurityMonitor.UI.StartButton.Text = "开始监测"

    -- 显示最终统计
    if #PhysicsSecurityMonitor.Metrics.physicsLatency > 0 then
        local avgPhysics = PhysicsSecurityMonitor.calculateAverage(PhysicsSecurityMonitor.Metrics.physicsLatency)
        local avgFPS = PhysicsSecurityMonitor.calculateAverage(PhysicsSecurityMonitor.Metrics.frameTimes)
        
        local finalText = string.format(
            "监测已停止\n\n最终统计:\n" ..
            "平均帧时间: %.1f ms\n" ..
            "平均FPS: %d\n" ..
            "总监测帧数: %d\n\n",
            avgPhysics, avgFPS, #PhysicsSecurityMonitor.Metrics.physicsLatency
        )
        
        if #PhysicsSecurityMonitor.SecurityAlerts > 0 then
            finalText = finalText .. string.format("安全警报: %d 次\n", #PhysicsSecurityMonitor.SecurityAlerts)
            finalText = finalText .. PhysicsSecurityMonitor.showSecurityLog()
        else
            finalText = finalText .. "安全警报: 无\n\n点击开始监测重新启动"
        end

        PhysicsSecurityMonitor.updateDisplay(finalText)
    else
        PhysicsSecurityMonitor.updateDisplay("监测已停止\n\n点击开始监测重新启动")
    end
end

-- 初始化
function PhysicsSecurityMonitor.init()
    if not game:IsLoaded() then
        game.Loaded:Wait()
    end

    PhysicsSecurityMonitor.createUI()

    -- 设置按钮事件
    PhysicsSecurityMonitor.UI.StartButton.MouseButton1Click:Connect(function()
        PhysicsSecurityMonitor.startMonitoring()
    end)

    PhysicsSecurityMonitor.UI.StopButton.MouseButton1Click:Connect(function()
        PhysicsSecurityMonitor.stopMonitoring()
    end)

    PhysicsSecurityMonitor.UI.SecurityButton.MouseButton1Click:Connect(function()
        PhysicsSecurityMonitor.toggleSecurityMonitoring()
    end)

    -- 添加快捷键
    local userInputService = game:GetService("UserInputService")
    if userInputService then
        userInputService.InputBegan:Connect(function(input, gameProcessed)
            if gameProcessed then return end

            if input.KeyCode == Enum.KeyCode.F6 then
                if not PhysicsSecurityMonitor.IsMonitoring then
                    PhysicsSecurityMonitor.startMonitoring()
                else
                    PhysicsSecurityMonitor.stopMonitoring()
                end
            elseif input.KeyCode == Enum.KeyCode.F7 then
                PhysicsSecurityMonitor.toggleSecurityMonitoring()
            end
        end)
    end

    PhysicsSecurityMonitor.updateDisplay("物理延迟与安全监测器已加载\n\n快捷键:\nF6 - 开始/停止监测\nF7 - 切换安全监测\n\n点击开始监测按钮或按F6开始")
end

-- 自动启动
spawn(function()
    wait(3)
    PhysicsSecurityMonitor.init()
end)

return PhysicsSecurityMonitor