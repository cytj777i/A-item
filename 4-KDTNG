-- 文件名：ServerImpactTest_Enhanced.lua
-- 增强版服务器影响测试 - 包含影响程度检测

local ImpactTest = {}
ImpactTest.Testing = false
ImpactTest.PlayerData = {}
ImpactTest.ImpactLevels = {
    NONE = {name = "无影响", color = Color3.new(0.2, 0.8, 0.2)},
    LIGHT = {name = "轻度影响", color = Color3.new(0.8, 0.8, 0.2)},
    MEDIUM = {name = "中度影响", color = Color3.new(1, 0.5, 0)},
    HEAVY = {name = "重度影响", color = Color3.new(1, 0.2, 0.2)},
    SEVERE = {name = "严重影响", color = Color3.new(0.8, 0, 0)}
}

-- 创建增强界面
function ImpactTest.createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ImpactTestGUI_Enhanced"
    screenGui.ResetOnSpawn = false

    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 350, 0, 280) -- 增加高度以容纳更多信息
    mainFrame.Position = UDim2.new(0.5, -175, 0.5, -140)
    mainFrame.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
    mainFrame.BorderSizePixel = 2
    mainFrame.BorderColor3 = Color3.new(0.5, 0.5, 0.5)
    mainFrame.Active = true
    mainFrame.Draggable = true

    -- 标题栏
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 25)
    titleBar.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
    titleBar.Parent = mainFrame

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, 0, 1, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "ciTiy服务器影响测试 - 增强版"
    titleLabel.TextColor3 = Color3.new(1, 1, 1)
    titleLabel.TextSize = 14
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Parent = titleBar

    -- 状态显示
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(1, -20, 0, 100)
    statusLabel.Position = UDim2.new(0, 10, 0, 30)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "点击开始测试按钮\n测试服务器影响程度\n\n状态：等待测试..."
    statusLabel.TextColor3 = Color3.new(1, 1, 1)
    statusLabel.TextSize = 12
    statusLabel.TextWrapped = true
    statusLabel.TextXAlignment = Enum.TextXAlignment.Center
    statusLabel.Parent = mainFrame

    -- 控制按钮
    local startBtn = Instance.new("TextButton")
    startBtn.Size = UDim2.new(0.45, 0, 0, 30)
    startBtn.Position = UDim2.new(0.025, 0, 0, 140)
    startBtn.BackgroundColor3 = Color3.new(0.2, 0.6, 0.2)
    startBtn.Text = "开始测试"
    startBtn.TextColor3 = Color3.new(1, 1, 1)
    startBtn.Parent = mainFrame

    local stopBtn = Instance.new("TextButton")
    stopBtn.Size = UDim2.new(0.45, 0, 0, 30)
    stopBtn.Position = UDim2.new(0.525, 0, 0, 140)
    stopBtn.BackgroundColor3 = Color3.new(0.8, 0.2, 0.2)
    stopBtn.Text = "停止测试"
    stopBtn.TextColor3 = Color3.new(1, 1, 1)
    stopBtn.Parent = mainFrame

    -- 影响程度显示
    local impactFrame = Instance.new("Frame")
    impactFrame.Size = UDim2.new(1, -20, 0, 60)
    impactFrame.Position = UDim2.new(0, 10, 0, 180)
    impactFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    impactFrame.BorderSizePixel = 1
    impactFrame.BorderColor3 = Color3.new(0.3, 0.3, 0.3)
    impactFrame.Parent = mainFrame

    local impactTitle = Instance.new("TextLabel")
    impactTitle.Size = UDim2.new(1, 0, 0, 20)
    impactTitle.BackgroundTransparency = 1
    impactTitle.Text = "影响程度分析"
    impactTitle.TextColor3 = Color3.new(1, 1, 1)
    impactTitle.TextSize = 12
    impactTitle.Font = Enum.Font.GothamBold
    impactTitle.Parent = impactFrame

    local impactLevelLabel = Instance.new("TextLabel")
    impactLevelLabel.Size = UDim2.new(0.5, -5, 0, 20)
    impactLevelLabel.Position = UDim2.new(0, 5, 0, 20)
    impactLevelLabel.BackgroundTransparency = 1
    impactLevelLabel.Text = "等级: 未测试"
    impactLevelLabel.TextColor3 = Color3.new(1, 1, 1)
    impactLevelLabel.TextSize = 11
    impactLevelLabel.TextXAlignment = Enum.TextXAlignment.Left
    impactLevelLabel.Parent = impactFrame

    local affectedPlayersLabel = Instance.new("TextLabel")
    affectedPlayersLabel.Size = UDim2.new(0.5, -5, 0, 20)
    affectedPlayersLabel.Position = UDim2.new(0.5, 0, 0, 20)
    affectedPlayersLabel.BackgroundTransparency = 1
    affectedPlayersLabel.Text = "受影响: 0/0"
    affectedPlayersLabel.TextColor3 = Color3.new(1, 1, 1)
    affectedPlayersLabel.TextSize = 11
    affectedPlayersLabel.TextXAlignment = Enum.TextXAlignment.Left
    affectedPlayersLabel.Parent = impactFrame

    local teleportsLabel = Instance.new("TextLabel")
    teleportsLabel.Size = UDim2.new(0.5, -5, 0, 20)
    teleportsLabel.Position = UDim2.new(0, 5, 0, 40)
    teleportsLabel.BackgroundTransparency = 1
    teleportsLabel.Text = "瞬移次数: 0"
    teleportsLabel.TextColor3 = Color3.new(1, 1, 1)
    teleportsLabel.TextSize = 11
    teleportsLabel.TextXAlignment = Enum.TextXAlignment.Left
    teleportsLabel.Parent = impactFrame

    local avgLatencyLabel = Instance.new("TextLabel")
    avgLatencyLabel.Size = UDim2.new(0.5, -5, 0, 20)
    avgLatencyLabel.Position = UDim2.new(0.5, 0, 0, 40)
    avgLatencyLabel.BackgroundTransparency = 1
    avgLatencyLabel.Text = "平均延迟: 0ms"
    avgLatencyLabel.TextColor3 = Color3.new(1, 1, 1)
    avgLatencyLabel.TextSize = 11
    avgLatencyLabel.TextXAlignment = Enum.TextXAlignment.Left
    avgLatencyLabel.Parent = impactFrame

    screenGui.Parent = game:GetService("CoreGui")
    mainFrame.Parent = screenGui

    -- 保存引用
    ImpactTest.UI = {
        ScreenGui = screenGui,
        StatusLabel = statusLabel,
        ImpactLevelLabel = impactLevelLabel,
        AffectedPlayersLabel = affectedPlayersLabel,
        TeleportsLabel = teleportsLabel,
        AvgLatencyLabel = avgLatencyLabel,
        StartBtn = startBtn,
        StopBtn = stopBtn,
        ImpactFrame = impactFrame
    }

    return screenGui
end

-- 记录玩家初始位置和延迟数据
function ImpactTest.recordPlayerPositions()
    ImpactTest.PlayerData = {}
    local players = game.Players:GetPlayers()
    local localPlayer = game.Players.LocalPlayer
    
    for _, player in ipairs(players) do
        if player ~= localPlayer and player.Character then
            local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
            if rootPart then
                ImpactTest.PlayerData[player.Name] = {
                    startPos = rootPart.Position,
                    positions = {rootPart.Position},
                    timestamps = {tick()},
                    lastPos = rootPart.Position,
                    movementDistances = {},
                    latencySamples = {}
                }
            end
        end
    end
end

-- 增强的玩家监控功能
function ImpactTest.monitorPlayers()
    local players = game.Players:GetPlayers()
    local localPlayer = game.Players.LocalPlayer
    
    for _, player in ipairs(players) do
        if player ~= localPlayer and player.Character then
            local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
            if rootPart and ImpactTest.PlayerData[player.Name] then
                local currentPos = rootPart.Position
                local playerData = ImpactTest.PlayerData[player.Name]
                local currentTime = tick()
                
                table.insert(playerData.positions, currentPos)
                table.insert(playerData.timestamps, currentTime)
                
                -- 计算移动距离和延迟
                local distance = (currentPos - playerData.lastPos).Magnitude
                table.insert(playerData.movementDistances, distance)
                
                -- 检查是否瞬移
                if distance > 20 then -- 移动距离超过20，认为是瞬移
                    playerData.teleports = (playerData.teleports or 0) + 1
                    playerData.lastTeleportTime = currentTime
                end
                
                -- 估算延迟（基于位置更新频率）
                if #playerData.timestamps > 1 then
                    local timeDiff = currentTime - playerData.timestamps[#playerData.timestamps - 1]
                    local estimatedLatency = math.max(0, timeDiff - 0.033) * 1000 -- 减去正常帧时间
                    table.insert(playerData.latencySamples, estimatedLatency)
                end
                
                playerData.lastPos = currentPos
            end
        end
    end
end

-- 增强的攻击模拟
function ImpactTest.sendTestData()
    local testData = {
        testType = "impact_test",
        timestamp = tick(),
        intensity = ImpactTest.currentIntensity or 1
    }
    
    -- 根据当前强度调整攻击频率
    local attackCount = math.min(5, ImpactTest.currentIntensity or 1)
    local remotesFound = 0
    
    local services = {game:GetService("ReplicatedStorage"), game:GetService("Workspace")}
    
    for _, service in ipairs(services) do
        for _, obj in ipairs(service:GetDescendants()) do
            if obj:IsA("RemoteEvent") and remotesFound < attackCount then
                pcall(function()
                    for i = 1, attackCount do
                        obj:FireServer(testData)
                    end
                    remotesFound = remotesFound + 1
                end)
            end
        end
    end
end

-- 分析影响程度
function ImpactTest.analyzeImpactLevel()
    local totalPlayers = 0
    local affectedPlayers = 0
    local totalTeleports = 0
    local totalLatency = 0
    local latencySamples = 0
    
    for playerName, data in pairs(ImpactTest.PlayerData) do
        totalPlayers = totalPlayers + 1
        
        -- 检查是否有瞬移
        if data.teleports and data.teleports > 0 then
            affectedPlayers = affectedPlayers + 1
            totalTeleports = totalTeleports + data.teleports
        end
        
        -- 计算平均延迟
        if data.latencySamples and #data.latencySamples > 0 then
            for _, latency in ipairs(data.latencySamples) do
                totalLatency = totalLatency + latency
                latencySamples = latencySamples + 1
            end
        end
    end
    
    local avgLatency = latencySamples > 0 and totalLatency / latencySamples or 0
    local affectedPercentage = totalPlayers > 0 and (affectedPlayers / totalPlayers) * 100 or 0
    local avgTeleportsPerAffected = affectedPlayers > 0 and totalTeleports / affectedPlayers or 0
    
    -- 判断影响程度
    local impactLevel = ImpactTest.ImpactLevels.NONE
    
    if affectedPlayers == 0 then
        impactLevel = ImpactTest.ImpactLevels.NONE
    elseif affectedPercentage < 30 and avgTeleportsPerAffected < 2 and avgLatency < 100 then
        impactLevel = ImpactTest.ImpactLevels.LIGHT
    elseif affectedPercentage < 60 and avgTeleportsPerAffected < 5 and avgLatency < 300 then
        impactLevel = ImpactTest.ImpactLevels.MEDIUM
    elseif affectedPercentage < 80 and avgTeleportsPerAffected < 10 and avgLatency < 500 then
        impactLevel = ImpactTest.ImpactLevels.HEAVY
    else
        impactLevel = ImpactTest.ImpactLevels.SEVERE
    end
    
    return {
        level = impactLevel,
        totalPlayers = totalPlayers,
        affectedPlayers = affectedPlayers,
        totalTeleports = totalTeleports,
        avgLatency = avgLatency,
        affectedPercentage = affectedPercentage
    }
end

-- 开始测试
function ImpactTest.startTest()
    if ImpactTest.Testing then return end
    
    ImpactTest.Testing = true
    ImpactTest.currentIntensity = 1
    ImpactTest.recordPlayerPositions()
    
    ImpactTest.UI.StatusLabel.Text = "测试进行中...\n监控其他玩家移动和延迟\n持续15秒钟"
    ImpactTest.UI.ImpactLevelLabel.Text = "等级: 测试中..."
    
    local startTime = tick()
    local testDuration = 15 -- 测试15秒
    
    -- 逐步增加攻击强度
    ImpactTest.IntensityTimer = 0
    
    -- 监控循环
    ImpactTest.MonitorConnection = game:GetService("RunService").Heartbeat:Connect(function(deltaTime)
        if not ImpactTest.Testing then return end
        
        ImpactTest.monitorPlayers()
        ImpactTest.sendTestData()
        
        -- 每3秒增加一次攻击强度
        ImpactTest.IntensityTimer = ImpactTest.IntensityTimer + deltaTime
        if ImpactTest.IntensityTimer >= 3 then
            ImpactTest.currentIntensity = math.min(5, ImpactTest.currentIntensity + 1)
            ImpactTest.IntensityTimer = 0
        end
        
        local elapsed = tick() - startTime
        if elapsed >= testDuration then
            ImpactTest.stopTest()
        end
    end)
    
    -- 更新界面
    ImpactTest.UpdateConnection = game:GetService("RunService").Heartbeat:Connect(function()
        if not ImpactTest.Testing then return end
        
        local elapsed = tick() - startTime
        local remaining = math.max(0, testDuration - elapsed)
        ImpactTest.UI.StatusLabel.Text = string.format("测试进行中...\n剩余时间: %.1f秒\n攻击强度: %d/5\n监控玩家: %d", 
            remaining, ImpactTest.currentIntensity, #game.Players:GetPlayers() - 1)
    end)
end

-- 停止测试并显示详细结果
function ImpactTest.stopTest()
    if not ImpactTest.Testing then return end
    
    ImpactTest.Testing = false
    
    if ImpactTest.MonitorConnection then
        ImpactTest.MonitorConnection:Disconnect()
    end
    
    if ImpactTest.UpdateConnection then
        ImpactTest.UpdateConnection:Disconnect()
    end
    
    -- 分析结果
    local results = ImpactTest.analyzeImpactLevel()
    
    -- 更新界面显示
    ImpactTest.UI.StatusLabel.Text = "测试完成!\n详细分析结果如下:"
    
    ImpactTest.UI.ImpactLevelLabel.Text = string.format("等级: %s", results.level.name)
    ImpactTest.UI.ImpactLevelLabel.TextColor3 = results.level.color
    
    ImpactTest.UI.AffectedPlayersLabel.Text = string.format("受影响: %d/%d (%.1f%%)", 
        results.affectedPlayers, results.totalPlayers, results.affectedPercentage)
    
    ImpactTest.UI.TeleportsLabel.Text = string.format("瞬移次数: %d", results.totalTeleports)
    
    ImpactTest.UI.AvgLatencyLabel.Text = string.format("平均延迟: %dms", math.floor(results.avgLatency))
    
    -- 显示详细描述
    local description = ImpactTest.getImpactDescription(results)
    ImpactTest.UI.StatusLabel.Text = string.format("测试完成!\n%s", description)
end

-- 获取影响程度描述
function ImpactTest.getImpactDescription(results)
    local descriptions = {
        [ImpactTest.ImpactLevels.NONE.name] = "服务器表现正常，未检测到明显影响。",
        [ImpactTest.ImpactLevels.LIGHT.name] = "轻微影响，少数玩家可能出现短暂卡顿。",
        [ImpactTest.ImpactLevels.MEDIUM.name] = "中度影响，部分玩家体验受到影响。",
        [ImpactTest.ImpactLevels.HEAVY.name] = "严重影响，多数玩家出现明显卡顿和瞬移。",
        [ImpactTest.ImpactLevels.SEVERE.name] = "服务器性能严重下降，建议立即停止测试。"
    }
    
    return string.format("%s\n受影响玩家: %d/%d | 平均延迟: %dms", 
        descriptions[results.level.name] or "未知影响程度",
        results.affectedPlayers, results.totalPlayers, math.floor(results.avgLatency))
end

-- 设置按钮功能
function ImpactTest.setupButtons()
    ImpactTest.UI.StartBtn.MouseButton1Click:Connect(function()
        ImpactTest.startTest()
    end)
    
    ImpactTest.UI.StopBtn.MouseButton1Click:Connect(function()
        ImpactTest.stopTest()
    end)
end

-- 初始化
function ImpactTest.init()
    if not game:IsLoaded() then
        game.Loaded:Wait()
    end
    
    ImpactTest.createUI()
    ImpactTest.setupButtons()
    
    ImpactTest.UI.StatusLabel.Text = "就绪\n点击开始测试按钮\n测试服务器影响程度"
end

-- 自动启动
spawn(function()
    wait(1)
    ImpactTest.init()
end)

return ImpactTest